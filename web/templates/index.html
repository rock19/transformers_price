<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Transformers ä»·æ ¼è¿½è¸ªç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 30px 0; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .features { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .feature-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .feature-card:hover { transform: translateY(-5px); border-color: #667eea; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .feature-card.active { border-color: #667eea; background: rgba(102, 126, 234, 0.2); }
        .feature-card .icon { font-size: 2.5em; margin-bottom: 12px; }
        .feature-card h3 { font-size: 1.1em; margin-bottom: 6px; }
        .feature-card p { font-size: 0.85em; opacity: 0.7; }
        .content { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 25px; min-height: 500px; backdrop-filter: blur(10px); }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        /* ç»Ÿè®¡æ ‡ç­¾ - ç£è´´æ ·å¼ */
        .stats-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-tag { padding: 10px 20px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); font-size: 14px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .stat-tag .num { font-weight: bold; font-size: 16px; margin-left: 6px; }
        .stat-tag.total { background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(102, 126, 234, 0.1)); border-color: #667eea; }
        .stat-tag.purchased { background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1)); border-color: #22c55e; }
        .stat-tag.not-purchased { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05)); border-color: rgba(255,255,255,0.3); }
        .stat-tag.followed { background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.1)); border-color: #3b82f6; }
        .stat-tag.not-followed { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05)); border-color: rgba(255,255,255,0.3); }
        
        .content-title { font-size: 1.4em; display: flex; align-items: center; gap: 12px; }
        .search-box input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 10px 15px; color: #fff; width: 250px; }
        .price-table { width: 100%; border-collapse: collapse; }
        .price-table th, .price-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: middle; }
        .price-table th { background: rgba(102, 126, 234, 0.15); font-weight: 600; font-size: 0.9em; }
        .product-img { width: 120px; height: 120px; border-radius: 10px; object-fit: cover; }
        .style-name { max-width: 180px; word-break: break-word; line-height: 1.4; }
        .style-name a { color: #667eea; text-decoration: none; word-break: break-word; }
        .style-name a:hover { text-decoration: underline; }
        .new-badge { display: inline-block; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-right: 5px; animation: pulse 1.5s infinite; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } }
        .price { font-weight: bold; font-size: 1.1em; white-space: nowrap; }
        .price-30d { color: #4ade80; }
        .price-min { color: #fbbf24; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .price-min:hover { color: #f59e0b; }
        .price-arrow { font-size: 0.9em; font-weight: bold; }
        .price-arrow.up { color: #ef4444; }
        .price-arrow.down { color: #22c55e; }
        .product-title { max-width: 250px; word-break: break-word; line-height: 1.4; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3em; display: flex; align-items: center; gap: 10px; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: #fff; font-size: 1.5em; cursor: pointer; padding: 5px 15px; border-radius: 10px; }
        .modal-close:hover { background: rgba(255,255,255,0.2); }
        .price-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .price-stat { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; text-align: center; }
        .price-stat-label { font-size: 0.85em; opacity: 0.7; margin-bottom: 5px; }
        .price-stat-value { font-size: 1.4em; font-weight: bold; }
        .price-stat-value.min { color: #22c55e; }
        .price-stat-value.max { color: #ef4444; }
        .price-stat-value.current { color: #667eea; }
        @media (max-width: 1200px) { .features { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .header h1 { font-size: 1.8em; } .features { grid-template-columns: 1fr; } .price-table { font-size: 0.85em; } .product-img { width: 40px; height: 40px; } }
        
        /* ç»Ÿè®¡åŒºåŸŸ */
        .stats-section { margin-bottom: 20px; }
        .stats-section h4 { font-size: 16px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Transformers ä»·æ ¼è¿½è¸ªç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§äº¬ä¸œã€å¤©çŒ«å•†å“ä»·æ ¼å˜åŒ–</p>
        </div>
        
        <div class="features">
            <div class="feature-card active" onclick="showTab('jd', this)">
                <div class="icon">ğŸ›’</div>
                <h3>äº¬ä¸œä»·æ ¼</h3>
                <p id="jd-count">{{ jd_products|length }} ä¸ªå•†å“</p>
            </div>
            <div class="feature-card" onclick="showTab('tmall', this)">
                <div class="icon">ğŸª</div>
                <h3>å¤©çŒ«ä»·æ ¼</h3>
                <p id="tmall-count">åŠ è½½ä¸­...</p>
            </div>
            <div class="feature-card" onclick="window.location.href='/maintain'">
                <div class="icon">ğŸ“¦</div>
                <h3>å•†å“ç»´æŠ¤</h3>
                <p>æ·»åŠ /ç¼–è¾‘å•†å“</p>
            </div>
            <div class="feature-card" onclick="showTab('trend', this)">
                <div class="icon">ğŸ“ˆ</div>
                <h3>ä»·æ ¼èµ°åŠ¿</h3>
                <p>å†å²è¶‹åŠ¿åˆ†æ</p>
            </div>
        </div>
        
        <div class="content">
            <!-- ç»Ÿè®¡ç£è´´ - äº¬ä¸œ -->
            <div id="stats-jd" class="stats-section" style="display:none;">
                <h4 style="margin-bottom:10px;color:#667eea;">ğŸ›’ äº¬ä¸œç»Ÿè®¡</h4>
                <div class="stats-bar">
                    <div class="stat-tag total">å…¨éƒ¨<span class="num" id="jd-total">0</span></div>
                    <div class="stat-tag purchased">å·²è´­ä¹°<span class="num" id="jd-purchased">0</span></div>
                    <div class="stat-tag not-purchased">æœªè´­ä¹°<span class="num" id="jd-not-purchased">0</span></div>
                    <div class="stat-tag followed">å·²å…³æ³¨<span class="num" id="jd-followed">0</span></div>
                    <div class="stat-tag not-followed">æœªå…³æ³¨<span class="num" id="jd-not-followed">0</span></div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ç£è´´ - å¤©çŒ« -->
            <div id="stats-tmall" class="stats-section" style="display:none;">
                <h4 style="margin-bottom:10px;color:#3b82f6;">ğŸª å¤©çŒ«ç»Ÿè®¡</h4>
                <div class="stats-bar">
                    <div class="stat-tag total">å…¨éƒ¨<span class="num" id="tmall-total">0</span></div>
                    <div class="stat-tag purchased">å·²è´­ä¹°<span class="num" id="tmall-purchased">0</span></div>
                    <div class="stat-tag not-purchased">æœªè´­ä¹°<span class="num" id="tmall-not-purchased">0</span></div>
                    <div class="stat-tag followed">å·²å…³æ³¨<span class="num" id="tmall-followed">0</span></div>
                    <div class="stat-tag not-followed">æœªå…³æ³¨<span class="num" id="tmall-not-followed">0</span></div>
                </div>
            </div>
            
            <div class="content-header">
                <div class="content-title">
                    <span id="content-icon">ğŸ›’</span>
                    <span id="content-title">äº¬ä¸œä»·æ ¼åˆ—è¡¨</span>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢å•†å“åç§°æˆ–ID..." onkeyup="applyKeywordFilter()">
                    <select id="filter-purchased" onchange="filterProducts()" style="margin-left: 15px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æœªè´­ä¹°" selected>æœªè´­ä¹°</option>
                        <option value="è´­ä¹°">å·²è´­ä¹°</option>
                    </select>
                    <select id="filter-followed" onchange="filterProducts()" style="margin-left: 10px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æœªå…³æ³¨">æœªå…³æ³¨</option>
                        <option value="å…³æ³¨">å·²å…³æ³¨</option>
                    </select>
                </div>
            </div>
            
            <table class="price-table">
                <thead>
                    <tr>
                        <th style="width:80px;">å›¾ç‰‡</th>
                        <th>æ¬¾å¼åç§°</th>
                        <th>äº§å“æ ‡é¢˜</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>åº—é¢åç§°</th>
                        <th>30æ—¥æœ€ä½</th>
                        <th>æœ€æ–°ä»·æ ¼</th>
                        <th>å†å²æœ€ä½</th>
                    </tr>
                </thead>
                <tbody id="product-list">
                    {% for p in jd_products %}
                    <tr data-id="{{ p.id }}" data-source="jd" data-style="{{ p.style_name|default('', true) }}" data-title="{{ p.title|default('', true) }}">
                        <td><img src="{{ p.image_url|default('', true) }}" class="product-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect fill=%22%23333%22 width=%2260%22 height=%2260%22/><text fill=%22%23666%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22>?</text></svg>'"></td>
                        <td class="style-name">
                            {% if p.is_new %}<span class="new-badge">NEW</span>{% endif %}
                            <a href="{{ p.product_url|default('#', true) }}" target="_blank" title="{{ p.style_name|default('', true) }}">{{ p.style_name|default('-', true) }}</a>
                        </td>
                        <td class="product-title" title="{{ p.title|default('', true) }}">{{ p.title|default('-', true) }}</td>
                        <td>{{ p.created_at_display }}</td>
                        <td>{{ p.shop_name|default('-', true) }}</td>
                        <td class="price price-30d">{% if p.min_price_30d %}Â¥{{ "%.2f"|format(p.min_price_30d) }}{% else %}-{% endif %}</td>
                        <td class="price price-tooltip" data-date="{{ p.latest_date|default('', true) }}">{% if p.min_price_30d and p.latest_price and p.latest_price > p.min_price_30d %}â†“{% elif p.min_price_30d and p.latest_price and p.latest_price < p.min_price_30d %}â†‘{% endif %}{% if p.latest_price %}Â¥{{ "%.2f"|format(p.latest_price) }}{% else %}-{% endif %}</td>
                        <td class="price price-min" onclick="showPriceHistory({{ p.id }}, 'jd')">{% if p.min_price_all %}Â¥{{ "%.2f"|format(p.min_price_all) }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="modal" id="price-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span id="modal-icon">ğŸ“ˆ</span>
                    <span id="modal-title">ä»·æ ¼èµ°åŠ¿</span>
                </div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            
            <div class="price-stats">
                <div class="price-stat">
                    <div class="price-stat-label">å†å²æœ€ä½</div>
                    <div class="price-stat-value min" id="stat-min">-</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-label">æœ€æ–°ä»·æ ¼</div>
                    <div class="price-stat-value current" id="stat-current">-</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-label">å†å²æœ€é«˜</div>
                    <div class="price-stat-value max" id="stat-max">-</div>
                </div>
            </div>
            
            <canvas id="price-chart" style="max-height:400px;"></canvas>
        </div>
    </div>
    
    <script>
    var currentTab = 'jd';
    var priceChart = null;
    var allProducts = { jd: [], tmall: [] };
    var filteredProducts = { jd: [], tmall: [] };
    
    function showTab(tab, el) {
        currentTab = tab;
        var cards = document.querySelectorAll('.feature-card');
        for (var i = 0; i < cards.length; i++) {
            cards[i].classList.remove('active');
        }
        if (el) {
            el.classList.add('active');
        } else {
            // é¡µé¢åŠ è½½æ—¶æ ¹æ® tab è®¾ç½® active
            cards.forEach(function(card) {
                if (tab === 'jd' && card === cards[0]) card.classList.add('active');
                else if (tab === 'tmall' && card === cards[1]) card.classList.add('active');
            });
        }
        
        var titles = {
            'jd': {icon: 'ğŸ›’', text: 'äº¬ä¸œä»·æ ¼åˆ—è¡¨'},
            'tmall': {icon: 'ğŸª', text: 'å¤©çŒ«ä»·æ ¼åˆ—è¡¨'},
            'maintain': {icon: 'ğŸ“¦', text: 'å•†å“ç»´æŠ¤'},
            'trend': {icon: 'ğŸ“ˆ', text: 'ä»·æ ¼èµ°åŠ¿åˆ†æ'}
        };
        
        document.getElementById('content-icon').textContent = titles[tab].icon;
        document.getElementById('content-title').textContent = titles[tab].text;
        
        // æ˜¾ç¤º/éšè—å¯¹åº”çš„ç£è´´ç»Ÿè®¡
        document.getElementById('stats-jd').style.display = tab === 'jd' ? 'block' : 'none';
        document.getElementById('stats-tmall').style.display = tab === 'tmall' ? 'block' : 'none';
        
        if (tab === 'jd') {
            document.getElementById('filter-purchased').value = 'æœªè´­ä¹°';
            filterProducts();
        } else if (tab === 'tmall') {
            document.getElementById('filter-purchased').value = '';
            filterProducts();
        } else if (tab === 'maintain' || tab === 'trend') {
            document.getElementById('product-list').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:50px;">åŠŸèƒ½å¼€å‘ä¸­...</td></tr>';
        }
    }
    
    function filterProducts() {
        var keyword = document.getElementById('search-input').value.toLowerCase();
        var purchased = document.getElementById('filter-purchased').value;
        var followed = document.getElementById('filter-followed').value;
        
        console.log('filterProducts called, tab:', currentTab, 'purchased:', purchased);
        
        if (currentTab === 'jd') {
            var xhr = new XMLHttpRequest();
            var url = '/api/jd-prices?purchased=' + encodeURIComponent(purchased) + '&followed=' + encodeURIComponent(followed);
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var products = JSON.parse(xhr.responseText);
                        console.log('äº¬ä¸œæ•°æ®åŠ è½½:', products.length, 'ä¸ª');
                        allProducts.jd = products;  // ä¿å­˜åŸå§‹æ•°æ®
                        filteredProducts.jd = products;
                        applyKeywordFilter('jd', keyword);
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
            };
            xhr.send();
        } else if (currentTab === 'tmall') {
            var xhr = new XMLHttpRequest();
            var url = '/api/tmall-prices?purchased=' + encodeURIComponent(purchased) + '&followed=' + encodeURIComponent(followed);
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var products = JSON.parse(xhr.responseText);
                        console.log('å¤©çŒ«æ•°æ®åŠ è½½:', products.length, 'ä¸ª');
                        allProducts.tmall = products;  // ä¿å­˜åŸå§‹æ•°æ®
                        filteredProducts.tmall = products;
                        applyKeywordFilter('tmall', keyword);
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
            };
            xhr.send();
        }
    }
    
    function applyKeywordFilter(source, keyword) {
        var products = filteredProducts[source] || [];
        
        // å…³é”®å­—ç­›é€‰ï¼ˆåªå¯¹åˆ—è¡¨æ˜¾ç¤ºæœ‰æ•ˆï¼‰
        if (keyword) {
            products = products.filter(function(p) {
                var style = (p.style_name || '').toLowerCase();
                var title = (p.title || '').toLowerCase();
                var productId = (p.product_id || '').toLowerCase();
                return style.indexOf(keyword) !== -1 || title.indexOf(keyword) !== -1 || productId.indexOf(keyword) !== -1;
            });
        }
        
        renderProducts(products, source);
    }
    
    function renderProducts(products, source) {
        var tbody = document.getElementById('product-list');
        
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:50px;opacity:0.6;">æš‚æ— æ•°æ®</td></tr>';
            return;
        }
        
        var html = '';
        var threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
        var threeDaysAgoStr = threeDaysAgo.toISOString().slice(0, 10);
        
        var html = '';
        for (var i = 0; i < products.length; i++) {
            var p = products[i];
            
            var isNew = false;
            if (p.created_at && p.created_at.slice) {
                var createdDate = p.created_at.slice(0, 10);
                if (createdDate >= threeDaysAgoStr) isNew = true;
            }
            var newBadge = isNew ? '<span class="new-badge">NEW</span>' : '';
            
            var min30dPrice = p.min_price_30d ? 'Â¥' + parseFloat(p.min_price_30d).toFixed(2) : '-';
            var latestPrice = p.latest_price ? 'Â¥' + parseFloat(p.latest_price).toFixed(2) : '-';
            var minAllPrice = p.min_price_all ? 'Â¥' + parseFloat(p.min_price_all).toFixed(2) : '-';
            
            var imgUrl = (p.image_url || '').replace(/&/g, '&amp;');
            var createdAt = (p.created_at_display || '-');
            var safeStyleName = (p.style_name || '-').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var safeTitle = (p.title || '-').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var safeShopName = (p.shop_name || '-').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var productUrl = (p.product_url || '#').replace(/&/g, '&amp;');
            var safeLatestDate = p.latest_date || '';
            
            html += '<tr data-id="' + p.id + '" data-source="' + source + '" data-style="' + (p.style_name || '') + '" data-title="' + (p.title || '') + '">';
            html += '<td><img src="' + imgUrl + '" class="product-img" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22><rect fill=%22%23333%22 width=%22120%22 height=%22120%22/><text fill=%22%23666%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22>?</text></svg>\'"></td>';
            html += '<td class="style-name">' + newBadge + '<a href="' + productUrl + '" target="_blank" title="' + safeStyleName + '">' + safeStyleName + '</a></td>';
            html += '<td class="product-title" title="' + safeTitle + '">' + safeTitle + '</td>';
            html += '<td>' + createdAt + '</td>';
            html += '<td>' + safeShopName + '</td>';
            html += '<td class="price price-30d">' + min30dPrice + '</td>';
            html += '<td class="price price-tooltip" data-date="' + safeLatestDate + '">' + latestPrice + '</td>';
            html += '<td class="price price-min" onclick="showPriceHistory(' + p.id + ', \'' + source + '\')">' + minAllPrice + '</td>';
            html += '</tr>';
        }
        
        if (!html) {
            html = '<tr><td colspan="8" style="text-align:center;padding:50px;opacity:0.6;">æš‚æ— æ•°æ®</td></tr>';
        }
        
        tbody.innerHTML = html;
    }
    
    // æ›´æ–°ç£è´´ç»Ÿè®¡ï¼ˆä¸å—ç­›é€‰å½±å“ï¼‰
    function updateStats(products, prefix) {
        if (!products || products.length === 0) {
            document.getElementById(prefix + '-total').textContent = '0';
            document.getElementById(prefix + '-purchased').textContent = '0';
            document.getElementById(prefix + '-not-purchased').textContent = '0';
            document.getElementById(prefix + '-followed').textContent = '0';
            document.getElementById(prefix + '-not-followed').textContent = '0';
            return;
        }
        
        var total = products.length;
        var purchased = products.filter(function(p) { return p.is_purchased === 'è´­ä¹°'; }).length;
        var notPurchased = products.filter(function(p) { return p.is_purchased === 'æœªè´­ä¹°'; }).length;
        var followed = products.filter(function(p) { return p.is_followed === 'å…³æ³¨'; }).length;
        var notFollowed = products.filter(function(p) { return p.is_followed === 'æœªå…³æ³¨'; }).length;
        
        document.getElementById(prefix + '-total').textContent = total;
        document.getElementById(prefix + '-purchased').textContent = purchased;
        document.getElementById(prefix + '-not-purchased').textContent = notPurchased;
        document.getElementById(prefix + '-followed').textContent = followed;
        document.getElementById(prefix + '-not-followed').textContent = notFollowed;
    }
    
    function showPriceHistory(productId, source) {
        var modal = document.getElementById('price-modal');
        var modalIcon = document.getElementById('modal-icon');
        var modalTitle = document.getElementById('modal-title');
        
        modalIcon.textContent = source === 'jd' ? 'ğŸ›’' : 'ğŸª';
        modalTitle.textContent = source === 'jd' ? 'äº¬ä¸œä»·æ ¼èµ°åŠ¿' : 'å¤©çŒ«ä»·æ ¼èµ°åŠ¿';
        
        modal.classList.add('show');
        
        document.getElementById('stat-min').textContent = '-';
        document.getElementById('stat-current').textContent = '-';
        document.getElementById('stat-max').textContent = '-';
        
        if (priceChart) {
            priceChart.destroy();
            priceChart = null;
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/price-history/' + productId + '?source=' + source, true);
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var history = JSON.parse(xhr.responseText);
                    
                    if (!history || history.length === 0) return;
                    
                    var prices = [];
                    for (var i = 0; i < history.length; i++) {
                        if (history[i].price) prices.push(parseFloat(history[i].price));
                    }
                    
                    var minPrice = prices.length ? Math.min.apply(null, prices) : null;
                    var maxPrice = prices.length ? Math.max.apply(null, prices) : null;
                    var currentPrice = history[0] && history[0].price ? parseFloat(history[0].price) : null;
                    
                    document.getElementById('stat-min').textContent = minPrice ? 'Â¥' + minPrice.toFixed(2) : '-';
                    document.getElementById('stat-current').textContent = currentPrice ? 'Â¥' + currentPrice.toFixed(2) : '-';
                    document.getElementById('stat-max').textContent = maxPrice ? 'Â¥' + maxPrice.toFixed(2) : '-';
                    
                    var ctx = document.getElementById('price-chart').getContext('2d');
                    
                    var labels = [];
                    for (var i = 0; i < history.length; i++) {
                        if (history[i].created_at && history[i].created_at.length >= 8) {
                            labels.push(history[i].created_at.slice(0, 4) + '-' + history[i].created_at.slice(4, 6) + '-' + history[i].created_at.slice(6, 8));
                        } else {
                            labels.push('-');
                        }
                    }
                    
                    var data = [];
                    for (var i = 0; i < history.length; i++) {
                        data.push(history[i].price);
                    }
                    
                    var minVal = minPrice;
                    var maxVal = maxPrice;
                    
                    priceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ä»·æ ¼',
                                data: data,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 5,
                                pointBackgroundColor: data.map(function(price) {
                                    if (price === minVal) return '#22c55e';
                                    if (price === maxVal) return '#ef4444';
                                    return '#667eea';
                                }),
                                pointBorderColor: data.map(function(price) {
                                    if (price === minVal) return '#22c55e';
                                    if (price === maxVal) return '#ef4444';
                                    return '#667eea';
                                })
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: 'rgba(255,255,255,0.7)', callback: function(value) { return 'Â¥' + value.toFixed(0); } }
                                },
                                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } }
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error:', e);
                }
            }
        };
        xhr.send();
    }
    
    function closeModal() {
        document.getElementById('price-modal').classList.remove('show');
    }
    
    document.getElementById('price-modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });
    
    // é¡µé¢åŠ è½½æ—¶åŠ è½½æ•°æ®
    window.onload = function() {
        // åˆå§‹åŒ–æ˜¾ç¤ºäº¬ä¸œï¼ˆä¼šåŒæ—¶åŠ è½½æ•°æ®ï¼‰
        showTab('jd');
        
        // é¢„åŠ è½½å¤©çŒ«æ•°æ®ï¼ˆåå°åŠ è½½ï¼‰
        var tmallXhr = new XMLHttpRequest();
        tmallXhr.open('GET', '/api/tmall-prices', true);
        tmallXhr.onload = function() {
            if (tmallXhr.status === 200) {
                try {
                    var products = JSON.parse(tmallXhr.responseText);
                    allProducts.tmall = products;
                    filteredProducts.tmall = products;
                } catch (e) {
                    console.error('Error:', e);
                }
            }
        };
        tmallXhr.send();
        
        // åŠ è½½äº¬ä¸œç»Ÿè®¡æ•°æ®ï¼ˆä¸å—ç­›é€‰å½±å“ï¼‰
        var jdStatsXhr = new XMLHttpRequest();
        jdStatsXhr.open('GET', '/api/jd-stats', true);
        jdStatsXhr.onload = function() {
            if (jdStatsXhr.status === 200) {
                try {
                    var stats = JSON.parse(jdStatsXhr.responseText);
                    document.getElementById('jd-count').textContent = stats.total + ' ä¸ªå•†å“';
                    document.getElementById('jd-total').textContent = stats.total;
                    document.getElementById('jd-purchased').textContent = stats.purchased;
                    document.getElementById('jd-not-purchased').textContent = stats.not_purchased;
                    document.getElementById('jd-followed').textContent = stats.followed;
                    document.getElementById('jd-not-followed').textContent = stats.not_followed;
                } catch (e) {
                    console.error('Error loading jd stats:', e);
                }
            }
        };
        jdStatsXhr.send();
        
        // åŠ è½½å¤©çŒ«ç»Ÿè®¡æ•°æ®ï¼ˆä¸å—ç­›é€‰å½±å“ï¼‰
        var tmallStatsXhr = new XMLHttpRequest();
        tmallStatsXhr.open('GET', '/api/tmall-stats', true);
        tmallStatsXhr.onload = function() {
            if (tmallStatsXhr.status === 200) {
                try {
                    var stats = JSON.parse(tmallStatsXhr.responseText);
                    document.getElementById('tmall-count').textContent = stats.total + ' ä¸ªå•†å“';
                    document.getElementById('tmall-total').textContent = stats.total;
                    document.getElementById('tmall-purchased').textContent = stats.purchased;
                    document.getElementById('tmall-not-purchased').textContent = stats.not_purchased;
                    document.getElementById('tmall-followed').textContent = stats.followed;
                    document.getElementById('tmall-not-followed').textContent = stats.not_followed;
                } catch (e) {
                    console.error('Error loading tmall stats:', e);
                }
            }
        };
        tmallStatsXhr.send();
    };
    </script>
</body>
</html>